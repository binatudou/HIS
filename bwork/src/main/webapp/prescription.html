<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="lib/jquery-easyui-1.7.0/themes/default/easyui.css">
  <link rel="stylesheet" type="text/css" href="lib/jquery-easyui-1.7.0/themes/icon.css">
  <script type="text/javascript" src="lib/jquery-easyui-1.7.0/jquery.min.js"></script>
  <script type="text/javascript" src="lib/jquery-easyui-1.7.0/jquery.easyui.min.js"></script>
</head>

<body onload="load()">
  <form id="presForm" action="presAdd" method="post">
    <div>
      <a href="javascript:void(0)" class="easyui-linkbutton" onclick="presRename()">修改处方名</a>
      <a href="javascript:void(0)" class="easyui-linkbutton" onclick="presClear()">清空处方</a>
      <a href="javascript:void(0)" class="easyui-linkbutton" onclick="presSubmit()">提交处方</a>
    </div>
    <table id="pres-dg" title="未命名处方" class="easyui-datagrid" toolbar="#toolbar" pagination="true" rownumbers="true" fitColumns="true" singleSelect="true">
      <thead>
        <tr>
          <th field="drugID" style="width: 10%;">药品id</th>
          <th field="drugName" style="width: 20%;">药品名</th>
          <th field="drugPrice" style="width: 10%;">药品单价</th>
          <th field="drugNumber" style="width: 10%;">药品数量</th>
          <th field="description" style="width: 50%;">使用说明</th>
        </tr>
      </thead>
    </table>

    <div id="toolbar">
      <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="add_drug()">添加药品</a>
      <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" plain="true" onclick="delete_drug()">删除药品</a>
      <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" plain="true" onclick="update_drug()">修改药品</a>
    </div>
  </form>

  <!-- 药品添加窗口 -->
  <div id="dlg" class="easyui-dialog" style="width:500px;height:500px;padding:10px 20px" closed="true" buttons="#dlg-buttons">
    <div class="ftitle">添加药品</div>
    <form id="drugForm" method="post">
      <div style="margin-bottom:10px">
        <input name="mnemonicCode" id="mnemonicCode" class="easyui-textbox" label="助记码:" labelAlign="right" style="width:100%">
      </div>
      <div style="margin-bottom:10px">
        <input name="drugID" id="drugID" class="easyui-textbox" required="true" label="*药品id:" labelAlign="right" style="width:100%">
      </div>
      <div style="margin-bottom:10px">
        <input name="drugName" id="drugName" class="easyui-textbox" readonly label="药品名:" labelAlign="right" style="width:100%">
      </div>
      <div style="margin-bottom:10px">
        <input name="drugPrice" id="drugPrice" class="easyui-textbox" required="true" readonly label="*单价:" labelAlign="right" style="width:100%">
      </div>
      <div style="margin-bottom:10px">
        <input name="drugNumber" id="drugNumber" class="easyui-textbox" type="number" required="true" label="*药品数量:" labelAlign="right" style="width:100%">
      </div>
      <div style="margin-bottom:20px">
        <label>*药品说明:</label>
        <input name="description" id="description" class="easyui-textbox" multiline="true" style="width:100%;height: 100px;">
      </div>
    </form>
  </div>
  <div id="dlg-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="save_drug()" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')" style="width:90px">取消</a>
  </div>

  <script>
    var pres_name = "";
    var drugs_info = [];

    function load() {
      //TODO: delete loadData
      // loadData();
      loadDrugs();

      //绑定函数
      $(function() {
        $("input", $("#mnemonicCode").next("span")).keyup(function() {
          search_drug();
        });
      });
    }

    //录入样本数据
    // function loadData() {
    //   $('#pres-dg').datagrid('insertRow', {
    //     row: {
    //       drugID: "11",
    //       drugName: "测试药品1",
    //       drugPrice: "3",
    //       drugNumber: "2",
    //       description: "药品1"
    //     }
    //   });

    //   $('#pres-dg').datagrid('insertRow', {
    //     row: {
    //       drugID: "12",
    //       drugName: "测试药品2",
    //       drugPrice: "500",
    //       drugNumber: "3",
    //       description: "药品2"
    //     }
    //   });
    // }

    //从服务器获取药品信息
    function loadDrugs() {
      $.ajax({
        type: 'GET',
        url: 'drugFindAll',
        dataType: 'JSON',
        success: function(result) {
          drugs_info = result;
        },
        error: function(e) {
          console.log(e.status);
          console.log(e.responseText);
        }
      });
      // drugs_info = [{
      //   "id": "1",
      //   "mnemonicCode": "ZSYJAZZ",
      //   "drugName": "注射用甲氨喋呤",
      //   "drugPrice": "15.73"
      // }, {
      //   "id": "2",
      //   "mnemonicCode": "FKZLHNZSY",
      //   "drugName": "氟康唑氯化钠注射液(大扶康)",
      //   "drugPrice": "7.01"
      // }, {
      //   "id": "3",
      //   "mnemonicCode": "PTTZSY",
      //   "drugName": "50%葡萄糖注射液(塑瓶)",
      //   "drugPrice": "25.16"
      // }, {
      //   "id": "4",
      //   "mnemonicCode": "YSTBZFYDPTP",
      //   "drugName": "盐酸特比萘芬阴道泡腾片（丁克）",
      //   "drugPrice": "40.62"
      // }, {
      //   "id": "5",
      //   "mnemonicCode": "HZ",
      //   "drugName": "红芪",
      //   "drugPrice": "30.79"
      // }];
    }

    //根据助记码搜索药品并录入数据
    function searchDrug() {
      var keyword = $("input", $("#mnemonicCode").next("span")).val();

      drugs_info.forEach(drug => {
        if (keyword == drug.mnemonicCode) {
          $("#drugID").textbox("setValue", drug.id);
          $("#drugName").textbox("setValue", drug.drugName);
          $("#drugPrice").textbox("setValue", drug.drugPrice);
        };
      });
    }

    //处方改名
    function presRename() {
      var new_title = prompt("请输入新的处方名", pres_name);
      if (new_title) {
        $("#pres-dg").datagrid({
          title: new_title
        });
        pres_name = new_title;
      }
    }

    //处方清空
    function presClear() {
      $.messager.confirm('Confirm', '警告：将清空处方', function(r) {
        if (r)
          $('#pres-dg').datagrid('loadData', {
            total: 0,
            rows: []
          });
      });
    }

    //处方逐条检查并提交
    function presSubmit() {
      //TODO
      $("presForm").submit({
        url: "presAdd",
        method: "post",
        onSubmit: function() {
          alert("1");
          var drugs = $('#pres-dg').datagrid('getData');
          //检查处方
          if (!drugs.total) {
            alert("提交失败：处方错误");
            return false;
          } else if (!pres_name) {
            alert("提交失败：请先命名处方");
            return false;
          } else if (drugs.total == 0) {
            alert("提交失败：无法提交空处方");
            return false;
          } else {
            for (let index = 0; index < drugs.length; index++) {
              const drug = drugs[index];
              if (!drug.drugID || !drug.drugPrice || !drug.drugNumber) {
                alert("提交失败：第" + index + "行药品格式错误");
                return false;
              }
            }
          }
          return true;
        },
        success: function(data) {
          if (data.success) {
            alert("提交成功");
            //清空处方
            $('#pres-dg').datagrid('loadData', {
              total: 0,
              rows: []
            });
          }
        },
        error: function(e) {
          console.log(e.status);
          console.log(e.responseText);
        }
      });
      // //提交处方
      // if (data.total > 0) {
      //   if (submit(drugs))
      //     alert("提交成功");
      //   else
      //     alert("提交失败");
      // }
    }

    //添加药品记录
    function addDrug() {
      //TODO
      $('#dlg').dialog('open').dialog('center').dialog('setTitle', '药品记录添加');
      $('#fm').form('clear');
    }

    //暂存药品记录
    function save_drug() {
      var drug_info = {
        drugID: $("input", $("#drugID").next("span")).val(),
        drugName: $("input", $("#drugName").next("span")).val(),
        drugPrice: $("input", $("#drugPrice").next("span")).val(),
        drugNumber: $("input", $("#drugNumber").next("span")).val(),
        description: $("input", $("#description").next("span")).val(),
      }
      $('#pres-dg').datagrid('insertRow', {
        row: drug_info
      });
      $('#dlg').dialog('close');
    }

    //删除药品记录
    function deleteDrug() {
      var row = $('#pres-dg').datagrid('getSelected');
      if (row) {
        $.messager.confirm('Confirm', '确认删除该药品吗？', function(r) {
          if (r) {
            var rowIndex = $('#pres-dg').datagrid('getRowIndex', row);
            $('#pres-dg').datagrid('deleteRow', rowIndex);
          }
        });
      } else {
        alert("未选择或无效药品记录");
      }
    }

    //修改药品记录
    function updateDrug() {
      //TODO
      var row = $('#pres-dg').datagrid('getSelected');
      if (row) {
        $('#dlg').dialog('open').dialog('center').dialog('setTitle', '药品记录修改');
        $('#fm').form('load', row);
      } else {
        alert("未选择或无效药品记录");
      }
    }
  </script>
</body>

</html>